[build-system]
build-backend = "hatchling.build"
requires = ["hatchling>=1.12.2"]

[project]
name = "clophfit"
description = "Cli for fitting macromolecule pH titration or binding assays data e.g. fluorescence spectra."
authors = [
  { name = "daniele arosio", email = "daniele.arosio@cnr.it" },
]
license = "BSD-3-Clause"
license-files = { paths = ["LICENSE.txt"] }
readme = "docs/README.md"
urls.Homepage = "https://github.com/darosio/ClopHfit"
urls."Bug Tracker" = "https://github.com/darosio/ClopHfit/issues"
urls.Discussions = "https://github.com/darosio/ClopHfit/discussions"
urls.Changelog = "https://darosio.github.io/ClopHfit/misc/CHANGELOG.html"
urls."Github releases" = "https://github.com/darosio/ClopHfit/releases"
urls.Documentation = "https://clophfit.readthedocs.io"
keywords = [
  "svd",
  "ClopHensor",
  "data fitting",
  "pH",
  "macromolecule binding",
  ]
classifiers = [
  "Environment :: Console",
  "Operating System :: OS Independent",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.8",
  "Programming Language :: Python :: 3.9",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Unix Shell",
  "Intended Audience :: Science/Research",
  "Topic :: Scientific/Engineering",
  "Development Status :: 3 - Alpha"
  ]
requires-python = ">=3.8, <3.12"
version = "0.4.4"
dependencies = [
  'click < 8.1.4',
  'corner < 2.2.2',
  'emcee < 3.1.5',
  'lmfit < 1.1.1',
  'matplotlib < 3.6.4',
  'numpy < 1.24.2',
  'openpyxl < 3.1.1',
  'pandas < 1.5.4',
  'rpy2 < 3.5.8',
  'scipy < 1.10.1',
  'seaborn < 0.12.3',
  'sympy < 1.11.2',
  'tqdm < 4.64.2',
  'xlrd < 2.0.2',
]
optional-dependencies.tests = [
  "coverage[toml] < 7.1.1",
  "mypy < 0.992",
  "pandas-stubs == 1.5.2.230105",  # XXX:
  "Pygments < 2.14.1",
  "pytest == 7.2.1",  # XXX: pdm show pytest
  "typeguard < 2.13.4",
  "xdoctest < 1.1.2",
]
optional-dependencies.dev = [
    "commitizen < 2.40.1",
    "ipykernel < 6.21.2",
    # "ipython < 8.9.1",
    "jupyter < 1.0.1",
]
# XXX: docs/requirements-docs for RTD
optional-dependencies.docs = [
  "autodocsumm < 0.2.11",
  "myst-parser < 0.18.2",
  "nbsphinx < 0.8.13",
  "pydata-sphinx-theme < 0.12.1",
  "Sphinx < 5.3.1",
  "sphinx-click < 4.4.1",
  "sphinx_autodoc_typehints < 1.22.1",
  "sphinxcontrib-plantuml < 0.24.2",
]

[project.scripts]
"clop" = "clophfit.__main__:clop"

[tool.hatch.envs.default]
# type = "pip-deepfreeze"  # pipx runpip hatch install hatch-pip-deepfreeze
features = ["dev", "tests", "docs"]
# extra-dependencies = []
python = "3.10"
[tool.hatch.envs.default.scripts]
# # --cov must not come before an argument in order to use the sources defined by config
# _cov = "pytest --cov --cov-report={env:COVERAGE_REPORT:term-missing} --cov-config=pyproject.toml"
# dev = "pytest -p no:randomly --no-cov {args:tests}"
# cov = "_cov -p no:randomly {args:tests}"
# full = "_cov -n auto --reruns 5 --reruns-delay 3 -r aR {args:tests}"
# [tool.hatch.envs.default.overrides]
# env.GITHUB_ACTIONS.env-vars = "COVERAGE_REPORT="
ciao = "echo 'ciao' {args:pilo liscio} {env:{home}}"  # XXX:

ch = "cz ch --incremental --unreleased-version HEAD"
clean = "rm -rf ./build .coverage ./__pycache__ ./.mypy_cache ./.pytest_cache ./docs/_build ./tests/__pycache__ ./dist ./src/clophfit/__pycache__"
init =  ["pre-commit install",
        "pre-commit install --hook-type commit-msg --hook-type pre-push"]
sync = "pip-df sync -x dev,docs,tests"
bump = [
     "cz bump --major-version-zero -ch {args}", # e.g. "--increment PATCH", "--files-only", "--no-verify" to bypass pre-commit and commit-msg hooks
     "hatch build",
     "hatch publish -r test",
     ]

[tool.hatch.envs.tests]
template = "tests"
features = ["tests"]
[tool.hatch.envs.tests.scripts]
sync = "pip-df sync -x tests"  # XXX:
test = "coverage run --parallel -m pytest"
type = "mypy src tests docs/conf.py"
xdoc = "python -m xdoctest clophfit all"
all = ["sync", "test", "type", "xdoc"]
[[tool.hatch.envs.tests.matrix]]
python = ["3.11", "3.10", "3.9", "3.8"] #reverse order to ensure the presence in older python of module included in newer versions

[tool.hatch.envs.coverage]
detached = true
dependencies = ["coverage[toml]>=7.1.0"]  # XXX:
[tool.hatch.envs.coverage.scripts]
combine = "coverage combine {args}"
report = "coverage report"
xml = "coverage xml"

[tool.hatch.envs.typeguard]
template = "typeguard"
features = ["tests"]
python = "3.11"
[tool.hatch.envs.typeguard.scripts]
# guard = "pytest", f"--typeguard-packages={package} {args}" see also {env:}  # XXX:
run = "pytest --typeguard-packages=clophfit {args}"

[tool.hatch.envs.lint]
detached = true
dependencies = ["pre-commit>=3.0.1"]  # XXX:
[tool.hatch.envs.lint.scripts]
run = "pre-commit run --all-files --hook-stage=manual --show-diff-on-failure {args}"

[tool.hatch.envs.docs]
template = "docs"
features = ["docs"]
[tool.hatch.envs.docs.scripts]
build = "sphinx-build docs docs/_build"
serve = "python -m http.server 8000 -d docs/_build"

[tool.coverage.paths]
source = ["src", "*/site-packages"]
tests = ["tests", "*/tests"]

[tool.coverage.run]
branch = true
source = ["clophfit", "tests"]
omit = ["*__init__.py"]

[tool.coverage.report]
show_missing = true
# fail_under = 100
exclude_lines = [
    "pragma: no cover",
    "pytest.raises",
    "pytest.warns",
    ]

[tool.black]
line-length = 88
skip-string-normalization = false
exclude = '''
/(
    \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | dist
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
force_single_line = true
# lines_after_imports = 2
known_first_party="clophfit"

[tool.pytest.ini_options]
minversion = "6.0"
addopts = ["-ra", "--showlocals", "--strict-markers", "--strict-config"]
# xfail_strict = true
# filterwarnings = ["ignore::DeprecationWarning", "ignore:OVER"]
filterwarnings = ["ignore::DeprecationWarning"]
log_cli_level = "INFO"
testpaths = [
  "tests",
]

[tool.mypy]
strict = true
warn_unreachable = true
pretty = true
show_column_numbers = true
show_error_codes = true
show_error_context = true
plugins = "numpy.typing.mypy_plugin"
exclude = "src/clophfit/old"
files = ["src", "tests", "docs/conf.py"]
python_version = "3.10"
warn_unused_configs = true
# enable_error_code = ["ignore-without-code", "redundant-expr", "truthy-bool"]
enable_error_code = ["redundant-expr", "truthy-bool"]

[tool.pylsp-mypy]
enabled = true
live_mode = true
dmypy = false
strict = true

[tool.commitizen]
name = "cz_customize"
version = "0.4.4"
tag_format = "v$version"
version_files = [
  "pyproject.toml:version",
  "docs/conf.py:release",
  "docs/README.md:Version",
  ]

[tool.commitizen.customize]
message_template = "{{change_type}}:{% if show_message %} {{message}}{% endif %}"
example = """fix(parser): correct minor typos in code\n
see the issue for details on the typos fixed\n
closes issue #12
"""
schema = """
<type>(<scope>): <subject>
<BLANK LINE>
<body>
<BLANK LINE>
(BREAKING CHANGE: )<footer>
"""
schema_pattern = "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|bump)(?:\\(([^()\r\n]*)\\)|\\()?(!)?:\\s(.*)?"
bump_pattern = "^(BREAKING CHANGE|feat|fix|perf|refactor)"
bump_map = {"^.+!:" = "MAJOR", "BREAKING CHANGE" = "MAJOR", "feat" = "MINOR", "fix" = "PATCH", "perf" = "PATCH", "refactor" = "PATCH"}
change_type_order = ["BREAKING CHANGE", "Feat", "Fix", "Docs", "Style", "Perf", "Test", "Build", "CI/CD"]
info_path = "cz_customize_info.txt"
commit_parser = "^(?P<change_type>feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(?:\\((?P<scope>[^()\r\n]*)\\)|\\()?(?P<breaking>!)?:\\s(?P<message>.*)?"
changelog_pattern = "^(feat|fix|docs|style|refactor|perf|test|build|ci)?(\\(.*\\))?(!)?"
change_type_map = {"feat" = "Feat", "fix" = "Fix", "docs" = "Docs", "build" = "Build", "style" = "Style", "refactor" = "Refactor", "perf" = "Perf", "test" = "Test", "ci" = "CI/CD"}

[[tool.commitizen.customize.questions]]
type = "list"
name = "change_type"
choices = [
{value = "feat", name = "feat: A new feature. Correlates with MINOR in SemVer"},
{value = "fix", name = "fix: A bug fix. Correlates with PATCH in SemVer"},
{value = "perf", name = "perf: A code change that improves performance. Correlates with PATCH in SemVer"},
{value = "docs", name = "docs: Documentation only changes"},
{value = "style", name = "style: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)"},
{value = "refactor", name = "refactor: A code change that neither fixes a bug nor adds a feature"},
{value = "test", name = "test: Adding missing or correcting existing tests"},
{value = "build", name = "build: Changes that update the build system, development tools or external dependencies"},
{value = "ci", name = "ci: Changes to our CI configuration files and scripts (example scopes: GitLabCI)"},
{value = "revert", name = "revert: Reverting to previous commit(s)."}
]
message = "Select the type of change you are committing"

[[tool.commitizen.customize.questions]]
type = "input"
name = "message"
message = "Body."

[[tool.commitizen.customize.questions]]
type = "confirm"
name = "show_message"
message = "Do you want to add body message in commit?"

[tool.pylint]
master.py-version = "3.10"
master.ignore-paths= ["src/clophfit/_version.py", "src/clophfit/old"]
reports.output-format = "colorized"
similarities.ignore-imports = "yes"
messages_control.disable = [
  "invalid-name",
  "design",
  "line-too-long",
  "too-many-lines",
  "inconsistent-return-statements",
  "import-error",
  "fixme",
  # "consider-using-f-string",
  # "unnecessary-pass",
  # "unspecified-encoding",
  # "unused-argument",
  # "raise-missing-from",
  # "use-a-generator",
  # "consider-using-generator",
  # "no-else-raise",
  # "protected-access",
  # "unidiomatic-typecheck",
  # "attribute-defined-outside-init",
  # # "all",
  # # https://pylint.pycqa.org/en/latest/user_guide/checkers/features.html
  # # for tests
  # "pointless-string-statement",
  # "consider-using-with",
  # "comparison-with-itself",
  # "comparison-of-constants",
  # "consider-using-with",
  # "use-maxsplit-arg",
  "unnecessary-dunder-call",
]
# messages_control.enable = ["raise-missing-from"]

[tool.ruff]
ignore = [
    "ANN001",
    "ANN101",
    "ANN102",
    "ANN201",
    "E501",
    "S101",
]
line-length = 88
select = [
    "A",                        # builtins
    "ANN",                      # typing annotation
    "ARG",                      # unused arguments
    "B",                        # bugbear
    "C",
    "C4",                       # comprehensions
    "C90",                      # mccabe
    # "COM", commas
    "D",                        # pydocstyle
    "DTZ",                      # dates
    "E",                        # pycodestyle
    "TRY",                      # exceptions
    "EM",                       # exceptions
    "ERA",                      # eradicate
    "F",                        # pyflakes
    # "FBT",                      # boolean-trap
    "I",                        # isort
    # "ICN", import conventions
    "ISC",                      # implicit-str-concat
    "N",                        # pep8-naming
    "PD",                       # pandas-vet
    # "PGH",  # pygrep WAIT
    "PT",                       # pytest-style
    "PTH",                      # use-pathlib
    "Q",                        # quotes
    "RUF",                      # Ruff
    # "S",    # bandit WAIT
    "SIM",                      # simplify
    "TID",                      # tidy-imports
    # "UP",   # pyupgrade WAIT
    "YTT",                      # 2020
    "W",                        # pycodestyle
]
extend-exclude = ["src/clophfit/old/"]
force-exclude = true

[tool.ruff.mccabe]
max-complexity = 33

[tool.ruff.pydocstyle]
convention = "numpy"

[tool.ruff.isort]
# combine-as-imports = true
force-single-line = true
# single-line-exclusions = ["os", "json"]
split-on-trailing-comma = true
known-first-party = ["src", "clophfit"]
# required-imports = ["from __future__ import annotations"]

[tool.ruff.per-file-ignores]
"tests/*" = [
    "ANN101",  # XXX:
    "ANN102",
    "S101",
]
"src/clophfit/prtecan.py" = [
    "B905",
    "E741",
]
